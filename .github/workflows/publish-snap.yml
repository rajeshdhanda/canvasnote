name: Publish CanvasNote Snap

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:  # Allow manual trigger
    inputs:
      channel:
        description: 'Snap Store channel'
        required: true
        default: 'stable'
        type: choice
        options:
          - stable
          - candidate
          - beta
          - edge

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  SNAP_NAME: canvasnote
  SNAP_ARCHITECTURES: amd64

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.tag.outputs.version }}
      tag: ${{ steps.tag.outputs.tag }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest tag and increment version
        id: tag
        run: |
          # Get the latest tag, or default to 0.0.0 if no tags exist
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Latest tag: $LATEST_TAG"
          
          # Remove 'v' prefix and split version
          VERSION=${LATEST_TAG#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          
          # Increment patch version
          PATCH=$((PATCH + 1))
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          NEW_TAG="v$NEW_VERSION"
          
          echo "New version: $NEW_VERSION"
          echo "New tag: $NEW_TAG"
          
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag=$NEW_TAG" >> $GITHUB_OUTPUT

      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a ${{ steps.tag.outputs.tag }} -m "Release ${{ steps.tag.outputs.tag }}"
          git push origin ${{ steps.tag.outputs.tag }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: CanvasNote ${{ steps.tag.outputs.tag }}
          body: |
            ## CanvasNote ${{ steps.tag.outputs.tag }}
            
            Automated release for version ${{ steps.tag.outputs.version }}
            
            ### Installation
            ```bash
            sudo snap install canvasnote
            ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-snap:
    runs-on: ubuntu-latest
    needs: create-release
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.create-release.outputs.tag }}

      - name: Set version from release
        id: version
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "SNAP_VERSION=$VERSION" >> $GITHUB_ENV
          echo "✓ Using version: $VERSION"

      - name: Install Snapcraft
        run: |
          sudo snap install snapcraft --classic

      - name: Login to Snapcraft
        env:
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_STORE_CREDENTIALS }}
        run: |
          # Export credentials for snapcraft
          echo "$SNAPCRAFT_STORE_CREDENTIALS" | snapcraft login --with -

      - name: Check Snapcraft login status
        run: |
          echo "Checking login status..."
          snapcraft whoami
          SNAPCRAFT_USER=$(snapcraft whoami | grep "email:" | awk '{print $2}')
          echo "✓ Logged in as: $SNAPCRAFT_USER"

      - name: Check snap name registration
        run: |
          echo "Checking snap name registration..."
          if snapcraft list-registered 2>&1 | grep -q "$SNAP_NAME"; then
            echo "✓ Snap name '$SNAP_NAME' is already registered"
          else
            echo "⚠ Snap name '$SNAP_NAME' is not registered"
            echo "Attempting to register..."
            if snapcraft register "$SNAP_NAME"; then
              echo "✓ Successfully registered '$SNAP_NAME'"
            else
              echo "✗ Failed to register snap name. It may already be taken."
              exit 1
            fi
          fi

      - name: Clean previous builds
        run: |
          echo "Cleaning previous builds..."
          snapcraft clean || true
          rm -f "${SNAP_NAME}_${SNAP_VERSION}_${SNAP_ARCHITECTURES}.snap"
          echo "✓ Cleaned previous builds"

      - name: Build snap package
        run: |
          echo "Building snap package..."
          # Update version in snapcraft.yaml
          sed -i "s/^version:.*/version: '$SNAP_VERSION'/" snapcraft.yaml
          echo "✓ Updated snapcraft.yaml with version: $SNAP_VERSION"
          
          snapcraft pack
          echo "✓ Snap built successfully"

      - name: Verify snap file
        run: |
          SNAP_FILE="${SNAP_NAME}_${SNAP_VERSION}_${SNAP_ARCHITECTURES}.snap"
          if [ ! -f "$SNAP_FILE" ]; then
            echo "✗ Snap file not found: $SNAP_FILE"
            exit 1
          fi
          SNAP_SIZE=$(du -h "$SNAP_FILE" | awk '{print $1}')
          echo "✓ Snap file ready: $SNAP_FILE ($SNAP_SIZE)"
          echo "SNAP_FILE=$SNAP_FILE" >> $GITHUB_ENV
          echo "SNAP_SIZE=$SNAP_SIZE" >> $GITHUB_ENV

      - name: Upload to Snap Store
        id: upload
        run: |
          echo "Uploading to Snap Store..."
          echo "⚠ This may take several minutes..."
          
          UPLOAD_OUTPUT=$(snapcraft upload "${SNAP_FILE}" 2>&1)
          echo "$UPLOAD_OUTPUT"
          
          # Extract revision number
          REVISION=$(echo "$UPLOAD_OUTPUT" | grep -oP "Revision \K[0-9]+" | head -1)
          
          if [ -n "$REVISION" ]; then
            echo "✓ Upload successful! Assigned revision: $REVISION"
            echo "REVISION=$REVISION" >> $GITHUB_ENV
          else
            echo "✗ Could not extract revision number from output"
            exit 1
          fi

      - name: Release to channel
        run: |
          # Determine channel: use workflow input if available, otherwise use env var
          CHANNEL="${{ github.event.inputs.channel }}"
          if [ -z "$CHANNEL" ]; then
            CHANNEL="stable"
          fi
          
          echo "Releasing to '$CHANNEL' channel..."
          
          if [ -z "$REVISION" ]; then
            echo "✗ Revision number is required for release"
            exit 1
          fi
          
          snapcraft release "$SNAP_NAME" "$REVISION" "$CHANNEL"
          echo "✓ Successfully released to '$CHANNEL' channel!"
          echo "CHANNEL=$CHANNEL" >> $GITHUB_ENV

      - name: Publication Summary
        run: |
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "  Snap Name:     $SNAP_NAME"
          echo "  Version:       $SNAP_VERSION"
          echo "  Revision:      $REVISION"
          echo "  Channel:       $CHANNEL"
          echo "  Architecture:  $SNAP_ARCHITECTURES"
          echo "  File Size:     $SNAP_SIZE"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "✨ CanvasNote published successfully!"
          echo ""
          echo "Users can now install with:"
          echo "  sudo snap install $SNAP_NAME"
          echo ""
          echo "View your snap at:"
          echo "  https://snapcraft.io/$SNAP_NAME"

      - name: Upload snap as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.SNAP_NAME }}-${{ env.SNAP_VERSION }}-${{ env.SNAP_ARCHITECTURES }}
          path: ${{ env.SNAP_FILE }}
          retention-days: 30

      - name: Update GitHub Release with snap file
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.create-release.outputs.tag }}
          files: |
            ${{ env.SNAP_FILE }}
          append_body: true
          body: |
            
            ### Snap Store Release Details
            - **Revision:** ${{ env.REVISION }}
            - **Channel:** ${{ env.CHANNEL }}
            - **File Size:** ${{ env.SNAP_SIZE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
